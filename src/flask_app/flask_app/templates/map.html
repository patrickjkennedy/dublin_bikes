<html>
  <head>
      <!-- font for heading, font for body -->
	  <link href="https://fonts.googleapis.com/css?family=Londrina+Sketch" rel="stylesheet">
	  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans:300" rel="stylesheet">
      <!--- link for favicon-->
      <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
	  
      <style>
          /* Document level styling for the entire page*/
            body{
                background-color: linen;
                  font-family: 'Josefin Sans', sans-serif;
            }
            h1 {
                justify-content: center;
                text-align: center;
                border-bottom-style: groove;
                border-bottom-color: black;
                margin-top: 20px;
                margin-left: 15%;
                margin-right: 15%;
                margin-bottom: 20px;
                font-family: 'Londrina Sketch', cursive;
                font-size: 80px;
            }
            #map{
                margin-left: 10%;
            }
            #selection{
                margin-left: 25%;
                padding-top: 10px;
            }
            #collectTime{
                position: relative;
                display:inline-block;
                padding-left: 200px;
            }
            #dropTime{
                position: relative;
                display:inline-block;
                padding-left: 200px;
            }
            #selectFrom{
                position: relative;
                display: inline-block;
            }
            #selectTo{
                position:relative;
                display:inline-block;
            }
            #container1{
                padding-bottom: 10px;
            }
            select{
                font-family: 'Josefin Sans', sans-serif;
                font-size: 15px;
                padding: 3px;
            }
        </style>
      <script>
          //accept json objects from Flask for station info and stand occupancy info//
          var stations = {{data_stations|tojson }};
          var availability = {{data_current_availability|tojson}};
          
          //following code is for generating an embedded Google map
          var map;
          function initMap() {
              map = new google.maps.Map(document.getElementById('map'), {
                  //set centre, coordinates found by searching for Dublin Lat/Long
                  center: new google.maps.LatLng(53.350140, -6.266155),
                  //sets the map to the "non-sattelite" view.  Better for viewing marker icons
                  mapTypeId: "terrain",
                  //sets level of zoom over the centre coordinates
                  zoom: 13,
              });
              
              //populate the map with marker locations.  locations / availability taken for 2 JSON objects
              for (var i = 0; i<stations.length ; i++){
                  var a = stations[i]['latitude'];
                  var b = stations[i]['longitude'];
                  var c = stations[i]['name'];
                  var d = availability[i]['available_bike_stands'];
                  var e = availability[i]['available_bikes'];
                  var f = stations[i]['number'];
                  
                  //Initially set the pop-up window to say "Loading..."
                  var infowindow = new google.maps.InfoWindow({
                      content: "Loading..."
                  });;
                  
                  var marker = new google.maps.Marker({
                      //position for each marker
                      position: {lat: a, lng: b},
                      map: map,
                      //icon located in static Flask folder
                      icon: "/static/bike.png",
                      //text to be included in the pop-up window
                      info: "Station: " + c + " <br><br>Available Bikes: " + e.toString() + "<br><br> Available Stands: " + d.toString(),
                      //following line added for use in calling JS function
                      //it populates the select box to correcpond with the current icon location 
                      stationNo: f,
                      //makes the icons "fall" onto the map on load.
                      animation: google.maps.Animation.DROP
                  });
                  
                  //code for actually creating the "info-window" on click of the icon/marker location
                  google.maps.event.addListener(marker, "click", function () {
                      //use the variable "info" we populated earlier
                      infowindow.setContent(this.info);
                      infowindow.open(map, this);
                      //this is the extra function to auto select the current station in the select box secction below the map
                      fillSelect(this.stationNo)
                  });
              }
          }
          //simple function that changes the "select" dropdown to the number supplied as the parameter for the function
          function fillSelect(number){
              document.getElementById('StationselectFrom').value = number;
          }
    </script>
    
      <!--Separate script tags for the async google maps API call-->
    <script src={{map_key}} async defer></script>
    </head>
    
    <body>
    <h1>Dublin Bikes - Journey Planner</h1>
    <div id="map" style="height: 50%; width:80%"></div>

    <div id="selection">
        <!--The following code is one single form, that will send results back to the Flask app for use in M-L model-->
        <!--The divs are empty but populated by JS functions-->
	    <form>
		    <div id="container1">
			<div id="selectFrom">Collect From:</div>
		    	<div id="collectTime">Collection Time:</div>
		    </div>
		    <div id="container2">
			    <div id="selectTo">Drop-off At:</div>
			    <div id="dropTime">Drop-off Time:</div>
		    </div>
	<input type='submit'></form>
    </div>
    <!--End of form data section-->
        
        <script>
            //The following JavaScript has to be below the main body of code, as it is calling Divs/elements that need to exist already
            function fillStation(thePlace){
                //create unique IDs for the select elements
                var id = "Station" + thePlace;
                //Make first option "default" to " - - - - "
                var text = "<br><select id=" + id + "> <option value=notSelected> - - - - </option>";
                //loop through and add an option for each Station
                for (var i=0; i<stations.length; i++){
                    var name = stations[i]['name'];
                    var num = stations[i]['number'];
                    text += "<option value=" + num + ">" + name + "</option>";
                }
                text += "</select>";
                //append text body to the Div
                document.getElementById(thePlace).innerHTML += text;
            }
            
            //function to fill select boxes with options for time - in 5 minute increments
            function fillTime(thePlace) {
                //create unique ID for both collect time and drop off time
                var id = "Select" + thePlace;
                var text = "<br><select id=" + id + ">";
                
                //loop through for hours / 5min increments
                //JS time is "1" and not "01" for single digit hrs/mins - therefore extra handling required for specific values
                for (var i=0; i<=23; i++){
                    for (var j=0; j<56; j+=5){
                        if (i==0 && j==0){
                            var time = "0:00";
                        }else if (i == 0){
                            if (j==5){
                                var time = "0" + ":" + "05";
                            }
                            else{
                                var time = "0" + ":" + j;
                              }
                        }else if (j==0){
                            var time = i + ":" + "00";
                        }else if (j==5){
                            var time = i + ":" + "05";
                        }else{
                            var time = i + ":" + j;
                        }
                        text += "<option value=" + time + ">" + time + "</option>"; 
                    }
                }
                text += "</select>";
                document.getElementById(thePlace).innerHTML += text;
            }
            
            //invoke functions to fill the 2 select boxes for stations and 2 select boxes for times.
            fillTime("collectTime");
            fillTime("dropTime");
            fillStation("selectFrom");
            fillStation("selectTo");
            
            //function to auto-select boxes to current time (nearest 10) and drop off time (+30)
            function autoTimeDrop(value1, value2){
            document.getElementById('SelectcollectTime').value = value1;
            document.getElementById('SelectdropTime').value = value2;

        }
            
            //create a new date Object.  Create hour and minute variables from this.
            var today = new Date();
            var hrs = today.getHours();
            var mins = today.getMinutes();
            
            //function to "correct" the hours / minutes to the nearest 10 minute interval (in the future)
            //takes hours and minutes as arguments
            function correctMin(hrs, mins){
            
            //convert hours and mins to string format.  autoTimeDrop() takes strings ass arguments
            var strHrs = hrs.toString();
            var strMins = mins.toString();
            
            //hours to be used to the "dropoff" time select dropdown
            var add30Hrs = hrs;
            
            // new value that time will be set to and "selected" for dropdown (string format)
            var newmins = "";
            
            //the following lines of code assess the hrs/mins values, and change the dropdown to the next 10min interval.
            if (strMins.length == 1){
                newmins = "10";
            }
            else{
                switch (strMins[0]){
                    case "1":
                      newmins = "20"; break;
                    case "2":
                      newmins = "30"; break;
                    case "3":
                      newmins = "40"; break;
                    case "4":
                      newmins = "50"; break;
                    case "5":
                      newmins = "00";
                      hrs = hrs +1; break;
                    }
            }
            
            //variable that will store the "drop-off" MINS value (add half a hour -- limit for free bike journey)
            var add30Mins = parseInt(newmins) + 30;
            
            //create string value to pass into function (current time)
            var value1 = hrs + ":" + newmins;
            
            //if 30mins is added, but total mins goes above 50 mins, we need to increase hour by 1 and take 60 away from mins
            if (add30Mins > 50){
                add30Hrs = add30Hrs + 1;
                add30Mins = add30Mins - 60;
                if (add30Mins==0){
                    add30Mins="00";
                }
            }
            
            //create string value to pass into function (collect in 30 mins time)
            var value2 = add30Hrs + ":" + add30Mins;
            
            //invoke the function to auto-select the 2 time dropdowns (collect time / drop-off time)
            autoTimeDrop(value1, value2);
            }
            //invoke function to change time to a multiple of 10
            correctMin(hrs, mins)
      </script>
  </body>
</html>
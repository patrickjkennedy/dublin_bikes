<html>
  <head>
      <!-- font for heading, font for body -->
	  <link href="https://fonts.googleapis.com/css?family=Londrina+Sketch" rel="stylesheet">
	  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans:300" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">
      <!--- link for favicon-->
      <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

      <style>
          /* Document level styling for the entire page*/
            body {
              background-color: #F0F7EE;
              font-family: 'Josefin Sans', sans-serif;
              font-size: 20px;
              margin: 0;
              color: #3d4852;
            }

            #header h1 {
              /* justify-content: center;
              text-align: left; */
              font-family:  "Helvetica Neue", Helvetica, Arial, sans-serif;
              font-size: 28px;
              color: #F0F7EE;
              padding-left: 20px;
              float: left;
            }

            #header img {
              float: right;
              margin-right: 25px;
              margin-top: 10px;
            }

            #header {
              background-color: #095971;
              width: 100%;
              float: left;
              margin-bottom: 10px;
            }

            #map {
              float: left;
              position: relative;
              border:1px solid black;
            }

            #legend {
              font-family: Arial, sans-serif;
              background: #fff;
              padding: 10px;
              margin: 10px;
              border: 3px solid #000;
                display: none;
            }

            #legend h3 {
              margin-top: 0;
            }

            #legend img {
              vertical-align: middle;
            }

            #page_content {
              margin-left: 3%;
              margin-right: 3%;
              margin-top: 10px;
            }

            #map_options {
              margin-left: 70%;
            }

            #weather_container {
              margin-left: 70%;
            }

            #weather_heading {
              text-align: center;
              font-weight: 900;
              font-size: 20px;
              margin-bottom: 8px;
            }

            #weather_image {
              float: right;
              margin-right: 50px;
            }

            #wind_temp {
              float: left;
              margin-top: 13px;
              margin-left: 12%;
            }

            #chart_container {
              float: right;
              margin-right: 2%;
            }

            #selection {
              margin-top: 20px;
              position: relative;
              float: left;
              text-align: center;
              width: 60%;
            }

            #button {
              background-color: #095971;
              border: none;
              color: white;
              padding: 15px 32px;
              text-align: center;
              text-decoration: none;
              display: inline-block;
              font-size: 16px;
              margin-top: 20px;
              border-radius: 5px;
              float: right;
              margin-right: 18%;
            }

            #container1 {
              float: left;
              margin-left: 15%;
              margin-right: 6%;
            }

            #container2 {
              float: left;
              margin-top: 3px;
            }

            #dropTime {
              position: relative;
              display:inline-block;
              margin-top: 10%;
            }

            #selectTo {
              position:relative;
              display:inline-block;
              margin-top: 7%;
            }

            #analytics_chart {
              margin-right: 15px;
            }
          #results{
              position: fixed;
              display: none;
              border-top-style: solid;
              border-bottom-style: solid;
              border-top-width: 1px;
              border-bottom-width: 4px;
              padding-left: 6%;
              padding-top: 1%;
              padding-bottom: 1%;
              padding-right: 6%;
              margin-left: 9%;
              margin-top: 22%;
              clear: both;
              margin-right: 20%;
              border-color: #095971;
          }

        </style>
      <script>
          //accept json objects from Flask for station info and stand occupancy info//
          var stations = {{data_stations|tojson}};
          var availability = {{data_current_availability|tojson}};

          //following code is for generating an embedded Google map
          var map;
          function initMap() {
              map = new google.maps.Map(document.getElementById('map'), {
                  //set centre, coordinates found by searching for Dublin Lat/Long
                  center: new google.maps.LatLng(53.350140, -6.266155),
                  //sets the map to the "non-sattelite" view.  Better for viewing marker icons
                  mapTypeId: "terrain",
                  //sets level of zoom over the centre coordinates
                  zoom: 13,
              });

              // Create the traffic layer and bike layer variables
              trafficLayer = new google.maps.TrafficLayer();
              bikeLayer = new google.maps.BicyclingLayer();
              
              setTimeout(legend, 2000);
              function legend(){
                var legend = document.getElementById('legend');
                legend.style.display = 'block';
                var div = document.createElement('placeholder');
                div.innerHTML = "<h3>Bicycle Availability</h3> <div><img src='/static/green_bike_small.png'>High</div><div><img src='/static/orange_bike_small.png'> Medium</div> <div><img src='/static/red_bike_small.png'> Low</div>";
                legend.appendChild(div);
            
                map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
              }
              
              

              //populate the map with marker locations.  locations / availability taken for 2 JSON objects
              for (var i = 0; i<stations.length ; i++){
                  var a = stations[i]['latitude'];
                  var b = stations[i]['longitude'];
                  var c = stations[i]['name'];
                  var d = availability[i]['available_bike_stands'];
                  var e = availability[i]['available_bikes'];
                  var f = stations[i]['number'];
                  var g = stations[i]['banking'];

                  //Initially set the pop-up window to say "Loading..."
                  var infowindow = new google.maps.InfoWindow({
                      content: "Loading..."
                  });;

                  var marker = new google.maps.Marker({
                      //position for each marker
                      position: {lat: a, lng: b},
                      map: map,
                      //icon located in static Flask folder
                      icon: getIcon(getPercentageAvailability(d,e)),
                      //text to be included in the pop-up window
                      info: "Station: " + c + " <br><br>Available Bikes: " + e.toString() + "<br><br> Available Stands: " + d.toString()
                      + "<br><br> Credit Card Availability: " + booleanFormatter(g),
                      //following line added for use in calling JS function
                      //it populates the select box to correpond with the current icon location
                      stationNo: f,
                      // add station name as property
                      stationName: c,
                      //makes the icons "fall" onto the map on load.
                      animation: google.maps.Animation.DROP
                  });

                  //code for actually creating the "info-window" on click of the icon/marker location
                  google.maps.event.addListener(marker, "click", function () {
                      //use the variable "info" we populated earlier
                      infowindow.setContent(this.info);
                      infowindow.open(map, this);
                      //this is the extra function to auto select the current station in the select box secction below the map
                      fillSelect(this.stationNo);
                      // Pass station number and name to the chart
                      updateChart(this.stationNo, this.stationName);
                  });
              }

              
          }
          function showResult(){
              document.getElementById('results').style.display = 'block';
          }
          //simple function that changes the "select" dropdown to the number supplied as the parameter for the function
          function fillSelect(number){
              document.getElementById('StationselectFrom').value = number;
          }

          // Formatter for Boolean Database values
          function booleanFormatter(number){
            if (number == 0){
              return "No";
            }
            else if (number == 1){
              return "Yes";
            }
            else return null;
          }

          // Determine which icon to use based on percentage availability
          function getIcon(percentage_availability){
            if (percentage_availability < 10){
              return "/static/red_bike.png"
            } else if (percentage_availability > 60){
              return "/static/green_bike.png"
            } else return "/static/orange_bike.png"
          }

          // Determine percentage availability
          function getPercentageAvailability(available_bike_stands, available_bikes){
            return (available_bikes/available_bike_stands)*100
          }

          // Display the traffic data
          function displayTraffic(checkbox){
            if (checkbox.checked){
              trafficLayer.setMap(map);
            } else {
              trafficLayer.setMap(null);
            }
          }

          // Display the bicycle layer
          function displayBikeInfo(checkbox){
            if (checkbox.checked){
              bikeLayer.setMap(map);
            } else {
              bikeLayer.setMap(null);
            }
          }
    </script>

      <!--Separate script tags for the async google maps API call-->
    <script src={{map_key}} async defer></script>
    </head>

    <body>
      <div id="header">
        <h1>Dublin Bikes | Journey Planner</h1>
        <img src="static/logo.png"/>
      </div>

<div id="page_content">

        <div id="map" style="height: 55%; width:65%"></div>

      <div id="weather_options_container">
        <div id="map_options">
          <form>
              <fieldset>
                  <legend>Map Options</legend>
              <div id="checkbox_inline">
                <input type="checkbox" onchange="displayTraffic(this)"/>
                <label for="traffic">Traffic</label>
              </div>
              <div id="checkbox_inline">
                <input type="checkbox" onclick="displayBikeInfo(this)"/>
                <label for="bike_info">Cyclist-Friendly Routes</label>
              </div>

            </fieldset>
          </form>
        </div>

        <div id="weather_container">
          <form>
              <fieldset>
                  <legend>Weather Info</legend>
                    <div id="weather_heading"></div>
                    <div id="weather_detail">
                        <div id="wind_temp"></div>
                        <div id="weather_image"></div>
                    </div>
              </fieldset>
          </form>
        </div>

        <div id="chart_container"></div>
        </div>

        <div id="selection">
            <!--The following code is one single form, that will send results back to the Flask app for use in M-L model-->
            <!--The divs are empty but populated by JS functions-->
    	    <form method="post">
    		    <div id="container1">
        			<div id="selectFrom">Collect From:</div>
              <div id="selectTo">Drop-off At:</div>
    		    </div>
    		    <div id="container2">
              <div id="collectTime">Collection Time:</div>
    			    <div id="dropTime">Drop-off Time:</div>
    		    </div>
    	    <input id="button" type='submit' onclick="showResult()"></form>
        </div>
  <div id='results'></div>
</div>



    <div id="legend">
    </div>
    <!--End of form data section-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
            //The following JavaScript has to be below the main body of code, as it is calling Divs/elements that need to exist already
            function fillStation(thePlace){
                //create unique IDs for the select elements
                var id = "Station" + thePlace;
                //Make first option "default" to " - - - - "
                var text = "<br><select id=" + id + " name=" + id + ">";
                //loop through and add an option for each Station
                for (var i=0; i<stations.length; i++){
                    var name = stations[i]['name'];
                    var num = stations[i]['number'];
                    text += "<option value=" + num + ">" + name + "</option>";
                }
                text += "</select>";
                //append text body to the Div
                document.getElementById(thePlace).innerHTML += text;
            }

            //function to fill select boxes with options for time - in 5 minute increments
            function fillTime(thePlace) {
                //create unique ID for both collect time and drop off time
                var id = "Select" + thePlace;

                var text = "<br><select id=" + id + " name =" + id +">";

                //loop through for hours / 5min increments
                //JS time is "1" and not "01" for single digit hrs/mins - therefore extra handling required for specific values
                for (var i=0; i<=23; i++){
                    for (var j=0; j<56; j+=5){
                        if (i==0 && j==0){
                            var time = "0:00";
                        }else if (i == 0){
                            if (j==5){
                                var time = "0" + ":" + "05";
                            }
                            else{
                                var time = "0" + ":" + j;
                              }
                        }else if (j==0){
                            var time = i + ":" + "00";
                        }else if (j==5){
                            var time = i + ":" + "05";
                        }else{
                            var time = i + ":" + j;
                        }
                        text += "<option value=" + time + ">" + time + "</option>";
                    }
                }
                text += "</select>";
                document.getElementById(thePlace).innerHTML += text;
            }

            //invoke functions to fill the 2 select boxes for stations and 2 select boxes for times.
            fillTime("collectTime");
            fillTime("dropTime");
            fillStation("selectFrom");
            fillStation("selectTo");

            //function to auto-select boxes to current time (nearest 10) and drop off time (+30)
            function autoTimeDrop(value1, value2){
            document.getElementById('SelectcollectTime').value = value1;
            document.getElementById('SelectdropTime').value = value2;

        }

            //create a new date Object.  Create hour and minute variables from this.
            var today = new Date();
            var hrs = today.getHours();
            var mins = today.getMinutes();

            //function to "correct" the hours / minutes to the nearest 10 minute interval (in the future)
            //takes hours and minutes as arguments
            function correctMin(hrs, mins){

            //convert hours and mins to string format.  autoTimeDrop() takes strings ass arguments
            var strHrs = hrs.toString();
            var strMins = mins.toString();

            //hours to be used to the "dropoff" time select dropdown
            var add30Hrs = hrs;

            // new value that time will be set to and "selected" for dropdown (string format)
            var newmins = "";

            //the following lines of code assess the hrs/mins values, and change the dropdown to the next 10min interval.
            if (strMins.length == 1){
                newmins = "10";
            }
            else{
                switch (strMins[0]){
                    case "1":
                      newmins = "20"; break;
                    case "2":
                      newmins = "30"; break;
                    case "3":
                      newmins = "40"; break;
                    case "4":
                      newmins = "50"; break;
                    case "5":
                      newmins = "00";
                      hrs = hrs +1;
		      add30Hrs = add30Hrs+1; break;
                    }
            }

            //variable that will store the "drop-off" MINS value (add half a hour -- limit for free bike journey)
            var add30Mins = parseInt(newmins) + 30;

            //create string value to pass into function (current time)
            var value1 = hrs + ":" + newmins;

            //if 30mins is added, but total mins goes above 50 mins, we need to increase hour by 1 and take 60 away from mins
            if (add30Mins > 50){
                add30Hrs = add30Hrs + 1;
                add30Mins = add30Mins - 60;
                if (add30Mins==0){
                    add30Mins="00";
                }
                if (add30Hrs==24){
                    add30Hrs="0";
                }
            }

            //create string value to pass into function (collect in 30 mins time)
            var value2 = add30Hrs + ":" + add30Mins;

            //invoke the function to auto-select the 2 time dropdowns (collect time / drop-off time)
            autoTimeDrop(value1, value2);
            }
            //invoke function to change time to a multiple of 10
            correctMin(hrs, mins)

            function updateChart(stationId, stationName){
              // Delete an existing chart if it is present
              if ($("canvas").length){
                $("canvas").remove();
              }

              // Add canvas
              $("div#chart_container").append("<canvas id=\"analytics_chart\" width=\"420px\" height=\"420px\"></canvas>");

              // API call to get JSON
              var base = "/api/station_occupancy_weekly/";
              var url = base + stationId;

              var jsonData = $.ajax({
                url: url,
                dataType: 'json',
              }).done(function (data) {

              // Get data from json
              var mean_available_bikes = JSON.parse(data["mean_available_bikes"]);
              var mean_available_stands = JSON.parse(data["mean_available_stands"]);
              var bikesData = [mean_available_bikes["available_bikes"]["Mon"],
                                                mean_available_bikes["available_bikes"]["Tue"],
                                                mean_available_bikes["available_bikes"]["Wed"],
                                                mean_available_bikes["available_bikes"]["Thurs"],
                                                mean_available_bikes["available_bikes"]["Fri"],
                                                mean_available_bikes["available_bikes"]["Sat"],
                                                mean_available_bikes["available_bikes"]["Sun"]];
              var standsData = [mean_available_stands["available_bike_stands"]["Mon"],
                                                mean_available_stands["available_bike_stands"]["Tue"],
                                                mean_available_stands["available_bike_stands"]["Wed"],
                                                mean_available_stands["available_bike_stands"]["Thurs"],
                                                mean_available_stands["available_bike_stands"]["Fri"],
                                                mean_available_stands["available_bike_stands"]["Sat"],
                                                mean_available_stands["available_bike_stands"]["Sun"]];

              // Create the chart.js data structure
              var chartData = {
                labels: ["Mon", 'Tue', 'Wed', 'Thurs', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Mean Bicycle Availability',
                    data: bikesData,
                    backgroundColor: 'rgba(255, 99, 132, 0.3)'
                },

                  {
                    label: 'Mean Stand Availability',
                    data: standsData,
                    backgroundColor: 'rgba(0, 99, 255, 0.3)'
                  }]
              };

              // Get the context of the canvas element we want to select
              var ctx = document.getElementById('analytics_chart').getContext('2d');
              ctx.fillStyle = "black";

              // Instantiate a new chart
              analyticsChart = new Chart(ctx, {
                type:'bar',
                data: chartData,
                options: {
                  responsive: false,
                  scales: {
                    xAxes: [{ stacked: true }],
                    yAxes: [{ stacked: true }]
                  },
                  title: {
                    display: true,
                    text: stationName
                  }
                }
              });
            });
          }

          // Display Weather info
          function weatherInfo(){

            // API call to get JSON
            var url = "/api/current_weather";

            var jsonData = $.ajax({
              url: url,
              dataType: 'json',
            }).done(function (data) {

              // Get weather forcast data from json
              var weatherInfo = data[0]["weather_main"];

              // This function is from coderwall.com - It is converting a datetime to UNIX
              Date.prototype.getUnixTime = function() { return this.getTime()/1000|0 };
              if(!Date.now) Date.now = function() { return new Date(); }
              Date.time = function() { return Date.now().getUnixTime(); }

              // Get sunset and sunrise time data from json
              var sunsetTime = data[0]["sys_sunset"];
              var sunriseTime = data[0]["sys_sunrise"];

              // Convert sunset and sunrise time data to unix time
              var sunsetToUnix = new Date(sunsetTime).getUnixTime();
              var sunriseToUnix = new Date(sunriseTime).getUnixTime();

              var temp = Math.round((data[0]["main_temp"] - 273.15));
              var wind = data[0]["wind_speed"];

              // displaying Temperature
              var displayTemp = ("Today's Temp: " + temp + " ÂºC");
              //document.getElementById("wind_temp").innerHTML = displayTemp;

              // Displaying Wind Speed
              var displayWind = ("Wind Speed: " + wind + " kph!")
              document.getElementById("wind_temp").innerHTML = displayTemp + "<p>" + displayWind;

              // This switch statement reads the data from the json file and returns
              // the matched value with an image and statement describing the current weather
              switch (weatherInfo) {
                case "Clouds":
                  var clouds = document.createElement("img");
                  clouds.src = "/static/clouds.png";
                  var src = document.getElementById("weather_image");
                  src.appendChild(clouds);
                  var comment = "The Forecast Predicts Cloudy!";
                  document.getElementById("weather_heading").innerHTML = comment;
                  break;

                case "Fog":
                  var fog = document.createElement("img");
                  fog.src = "/static/fog.png";
                  var src = document.getElementById("weather_image");
                  src.appendChild(fog);
                  var comment = "The Forecast Predicts Fog!";
                  document.getElementById("weather_heading").innerHTML = comment;
                  break;

                case "Drizzle":
                  var drizzle = document.createElement("img");
                  drizzle.src = "/static/drizzle.png";
                  var src = document.getElementById("weather_image");
                  src.appendChild(drizzle);
                  var comment = "It Is Drizzling Right Now!";
                  document.getElementById("weather_heading").innerHTML = comment;
                  break;

                case "Mist":
                  var mist = document.createElement("img");
                  mist.src = "/static/mist.png";
                  var src = document.getElementById("weather_image");
                  src.appendChild(mist);
                  var comment = "The Forecast Predicts Mist!";
                  document.getElementById("weather_heading").innerHTML = comment;
                  break;

                case "Rain":
                  var rain = document.createElement("img");
                  rain.src = "/static/rain.png";
                  var src = document.getElementById("weather_image");
                  src.appendChild(rain);
                  var comment = "It Is Raining Right Now!";
                  document.getElementById("weather_heading").innerHTML = comment;
                  break;

                case "Snow":
                  var snow = document.createElement("img");
                  snow.src = "/static/snow.png";
                  var src = document.getElementById("weather_image");
                  src.appendChild(snow);
                  var comment = "It Is Snowing Right Now!";
                  document.getElementById("weather_heading").innerHTML = comment;
                  break;

                case "Clear":
                  var currentTime = new Date();
                  var time = currentTime.getTime()/1000;
                  console.log(sunsetToUnix);
                  console.log(time)
                  if (time >= sunsetToUnix && time <= sunriseToUnix){
                    var clear = document.createElement("img");
                    clear.src = "/static/clear_moon.png";
                    var src = document.getElementById("weather_image");
                    src.appendChild(clear);
                    var comment = "Clear Skies Tonight!";
                    document.getElementById("weather_heading").innerHTML = comment;
                    break;
                  }
                  else if (time >= sunriseToUnix && time <= sunsetToUnix) {
                    var clear = document.createElement("img");
                    clear.src = "/static/clear_sun.png";
                    var src = document.getElementById("weather_image");
                    src.appendChild(clear);
                    var comment = "Today Will Be a Sunny Day!";
                    document.getElementById("weather_heading").innerHTML = comment;
                    break;
                  }

                default:
                  var weather = "Sorry, No Weather Today";
                  document.getElementById("weather_heading").innerHTML = weather;
              }
            });
          }

          // When page loads weather function is called
          window.onload=weatherInfo();


      </script>
	<script>
        var stations = {{data_stations|tojson }};
        var stations_availability = {{data_current_availability|tojson}};
		$(function() {
    $('form').submit(function(e) {
        $.ajax({
            url: '/user_input',
            data: $('form').serialize(),
            type: 'GET',
            success: function(response) {
                var stationNumber1 = response['from_station']-2;
                var stationNumber2 = response['to_station']-2;
                if (stationNumber1 > 17){
                    stationNumber1 -= 1;
                }
                if (stationNumber2 > 17){
                    stationNumber2 -= 1;
                }

                var to_station_num_bikes = parseInt(response['to_station_stand_availability']);
                var total_bikes = parseInt(stations_availability[stationNumber2]['bike_stands']);
                var availability = total_bikes - to_station_num_bikes;

                document.getElementById('results').innerHTML = "At <b>" + stations[stationNumber1]['address'] + "</b> at " + response['from_time'] + ":" + response['from_mins'] + " there will be close to " + response['from_station_bike_availability'] + " bikes available." + "<br><br> At <b>" + stations[stationNumber2]['address'] + "</b> at " + response['to_time'] + ":" + response['to_mins'] + " there will be close to " + availability + " stands available.";
            },
            error: function(error) {
                console.log(error);
            }
        });
        e.preventDefault();
    });
});

	</script>
  </body>
</html>
